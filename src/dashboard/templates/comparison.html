{% extends "detail_page.html" %}

{% block title %}Team Comparison{% endblock %}
{% block page_title %}Team Comparison{% endblock %}

{% block header_title %}Team Comparison{% endblock %}

{% block page_description %}
<div class="page-description">
    Cross-Team Performance Analysis
</div>
{% endblock %}

{% block period_info %}
üìä Comparing last {{ config.days_back if config else 90 }} days
{% endblock %}

{% block breadcrumb_items %}
<a href="/comparison">Team Comparison</a>
{% endblock %}

{% block main_content %}
<div class="comparison-container">

<!-- Overall Performance Score Card -->
<div class="card" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">üèÜ Overall Performance</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        {% for team_name, team_data in comparison.items() %}
        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; text-align: center; {% if team_data.score == comparison.values()|map(attribute='score')|max %}border: 3px solid var(--success);{% else %}border: 2px solid var(--border-color);{% endif %}">
            <div class="display-md" style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">
                {{ team_name }}
            </div>
            <div class="text-sm" style="color: var(--text-secondary); margin-bottom: 10px;">
                {{ team_data.team_size }} members
            </div>
            <div class="display-xl" style="font-weight: 700; color: var(--accent-primary); margin: 15px 0;">
                {{ team_data.score }}
            </div>
            <div class="text-sm" style="color: var(--text-secondary); margin-bottom: 15px;">Performance Score (per member)</div>
            <div class="display-sm" style="color: var(--success); font-weight: 600;">
                {{ team_wins.get(team_name, 0) }} metric wins
            </div>
            {% if team_data.score == comparison.values()|map(attribute='score')|max %}
            <div style="margin-top: 10px; font-size: 1.5em;">üëë</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Overall Performance Radar Chart -->
<div class="card">
    <h2>Performance Overview</h2>
    <p class="helper-text">
        Comprehensive view of all metrics across teams. Larger area indicates better overall performance.
    </p>
    <div id="radar-comparison" style="height: 500px;"></div>
</div>

<div class="card">
            <h2>GitHub Metrics Comparison</h2>
            <p class="helper-text">
                Side-by-side comparison of GitHub activity metrics between teams. The winning team for each metric is highlighted in green.
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th class="team-native">Native</th>
                        <th class="team-webtc">WebTC</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Pull Requests</strong></td>
                        <td {% if comparison.Native.prs > comparison.WebTC.prs %}class="winner"{% endif %}>
                            {{ comparison.Native.prs }}
                        </td>
                        <td {% if comparison.WebTC.prs > comparison.Native.prs %}class="winner"{% endif %}>
                            {{ comparison.WebTC.prs }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Code Reviews</strong></td>
                        <td {% if comparison.Native.reviews > comparison.WebTC.reviews %}class="winner"{% endif %}>
                            {{ comparison.Native.reviews }}
                        </td>
                        <td {% if comparison.WebTC.reviews > comparison.Native.reviews %}class="winner"{% endif %}>
                            {{ comparison.WebTC.reviews }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Commits</strong></td>
                        <td {% if comparison.Native.commits > comparison.WebTC.commits %}class="winner"{% endif %}>
                            {{ comparison.Native.commits }}
                        </td>
                        <td {% if comparison.WebTC.commits > comparison.Native.commits %}class="winner"{% endif %}>
                            {{ comparison.WebTC.commits }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Avg PR Cycle Time</strong></td>
                        <td {% if comparison.Native.avg_cycle_time < comparison.WebTC.avg_cycle_time and comparison.Native.avg_cycle_time > 0 %}class="winner"{% endif %}>
                            {{ "%.1f"|format(comparison.Native.avg_cycle_time) }}h
                        </td>
                        <td {% if comparison.WebTC.avg_cycle_time < comparison.Native.avg_cycle_time and comparison.WebTC.avg_cycle_time > 0 %}class="winner"{% endif %}>
                            {{ "%.1f"|format(comparison.WebTC.avg_cycle_time) }}h
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 style="margin: 30px 0 15px 0;">Visual Comparison</h2>
        <p class="helper-text" style="margin: 0 0 20px 0;">
            Visual comparison of team performance across key GitHub metrics. Charts show relative volumes and efficiency between teams.
        </p>

        <div class="comparison-grid">
            <div class="card">
                <h2>Pull Requests</h2>
                <div id="pr-comparison"></div>
            </div>

            <div class="card">
                <h2>Code Reviews</h2>
                <div id="review-comparison"></div>
            </div>

            <div class="card">
                <h2>Commits</h2>
                <div id="commit-comparison"></div>
            </div>

            <div class="card">
                <h2>PR Cycle Time</h2>
                <div id="cycle-time-comparison"></div>
            </div>
        </div>

        <script>
            // Get theme-aware colors
            function getChartColors() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                return {
                    paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    font_color: isDark ? '#e0e0e0' : '#2c3e50',
                    grid_color: isDark ? '#444' : '#ecf0f1'
                };
            }

            // Common layout configuration
            function getChartLayout(title, yaxisTitle) {
                const colors = getChartColors();
                return {
                    title: {
                        text: title,
                        font: {size: 14}
                    },
                    yaxis: {
                        title: yaxisTitle,
                        gridcolor: colors.grid_color,
                        color: colors.font_color,
                        showticklabels: true,
                        tickfont: {size: 11}
                    },
                    xaxis: {
                        color: colors.font_color,
                        showticklabels: true,
                        tickfont: {size: 11},
                        tickangle: -45
                    },
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color, size: 11},
                    width: 600,
                    height: 400,
                    margin: {l: 60, r: 30, t: 50, b: 100},
                    autosize: false
                };
            }

            // Common config
            const config = {responsive: false, displayModeBar: false};

            // Radar Chart - Overall Performance
            (function() {
                const colors = getChartColors();

                // Normalize metrics to 0-100 scale for fair comparison
                const teams = {{ comparison.keys() | list | tojson }};
                const teamData = {{ comparison | tojson }};

                // Get min/max for each metric
                const prs = teams.map(t => teamData[t].prs);
                const reviews = teams.map(t => teamData[t].reviews);
                const commits = teams.map(t => teamData[t].commits);
                const cycleTimes = teams.map(t => teamData[t].avg_cycle_time).filter(v => v > 0);
                const throughputs = teams.map(t => teamData[t].jira_throughput);

                function normalize(value, min, max) {
                    if (max === min) return 50;
                    return ((value - min) / (max - min)) * 100;
                }

                const traces = teams.map((teamName, idx) => {
                    const team = teamData[teamName];
                    const prScore = normalize(team.prs, Math.min(...prs), Math.max(...prs));
                    const reviewScore = normalize(team.reviews, Math.min(...reviews), Math.max(...reviews));
                    const commitScore = normalize(team.commits, Math.min(...commits), Math.max(...commits));
                    // For cycle time, lower is better, so invert
                    const cycleScore = cycleTimes.length > 0 && team.avg_cycle_time > 0
                        ? 100 - normalize(team.avg_cycle_time, Math.min(...cycleTimes), Math.max(...cycleTimes))
                        : 50;
                    const throughputScore = normalize(team.jira_throughput, Math.min(...throughputs), Math.max(...throughputs));

                    return {
                        type: 'scatterpolar',
                        r: [prScore, reviewScore, commitScore, cycleScore, throughputScore],
                        theta: ['Pull Requests', 'Code Reviews', 'Commits', 'Cycle Time', 'Jira Throughput'],
                        fill: 'toself',
                        name: teamName,
                        marker: {color: idx === 0 ? '#3498db' : '#9b59b6'},
                        line: {color: idx === 0 ? '#3498db' : '#9b59b6'}
                    };
                });

                const radarLayout = {
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, 100],
                            gridcolor: colors.grid_color,
                            color: colors.font_color
                        },
                        angularaxis: {
                            gridcolor: colors.grid_color,
                            color: colors.font_color
                        }
                    },
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color, size: 12},
                    showlegend: true,
                    legend: {
                        x: 0.5,
                        xanchor: 'center',
                        y: -0.1,
                        yanchor: 'top',
                        orientation: 'h'
                    },
                    height: 500
                };

                Plotly.newPlot('radar-comparison', traces, radarLayout, {responsive: true});
            })();

            // PR Chart
            Plotly.newPlot('pr-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.prs }}, {{ comparison.WebTC.prs }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Pull Requests by Team', 'Number of PRs'), config);

            // Review Chart
            Plotly.newPlot('review-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.reviews }}, {{ comparison.WebTC.reviews }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Reviews by Team', 'Number of Reviews'), config);

            // Commits Chart
            Plotly.newPlot('commit-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.commits }}, {{ comparison.WebTC.commits }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Commits by Team', 'Number of Commits'), config);

            // Cycle Time Chart
            Plotly.newPlot('cycle-time-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.avg_cycle_time }}, {{ comparison.WebTC.avg_cycle_time }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Avg PR Cycle Time (Lower is Better)', 'Hours'), config);
        </script>

        {% if comparison.Native.jira_throughput or comparison.WebTC.jira_throughput %}
        <div class="card">
            <h2>Jira Metrics Comparison</h2>
            <p class="helper-text">
                Side-by-side comparison of Jira delivery metrics between teams. Higher throughput and lower WIP generally indicate better flow.
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th class="team-native">Native</th>
                        <th class="team-webtc">WebTC</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Throughput (issues/week)</strong></td>
                        <td {% if comparison.Native.jira_throughput > comparison.WebTC.jira_throughput %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['Native'].jira.filters.completed_12weeks }}"
                               target="_blank"
                               class="jira-filter-link"
                               style="color: inherit;">
                                {{ "%.1f"|format(comparison.Native.jira_throughput) }}
                            </a>
                        </td>
                        <td {% if comparison.WebTC.jira_throughput > comparison.Native.jira_throughput %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['WebTC'].jira.filters.completed_12weeks }}"
                               target="_blank"
                               class="jira-filter-link"
                               style="color: inherit;">
                                {{ "%.1f"|format(comparison.WebTC.jira_throughput) }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>WIP Count</strong></td>
                        <td>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['Native'].jira.filters.wip }}"
                               target="_blank"
                               class="jira-filter-link"
                               style="color: inherit;">
                                {{ comparison.Native.jira_wip }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['WebTC'].jira.filters.wip }}"
                               target="_blank"
                               class="jira-filter-link"
                               style="color: inherit;">
                                {{ comparison.WebTC.jira_wip }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Flagged/Blocked</strong></td>
                        <td {% if comparison.Native.jira_flagged < comparison.WebTC.jira_flagged %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['Native'].jira.filters.flagged_blocked }}"
                               target="_blank"
                               class="bug-filter-link"
                               style="color: inherit;">
                                {{ comparison.Native.jira_flagged }}
                            </a>
                        </td>
                        <td {% if comparison.WebTC.jira_flagged < comparison.Native.jira_flagged %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['WebTC'].jira.filters.flagged_blocked }}"
                               target="_blank"
                               class="bug-filter-link"
                               style="color: inherit;">
                                {{ comparison.WebTC.jira_flagged }}
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

</div> <!-- End of comparison-container -->
{% endblock %}

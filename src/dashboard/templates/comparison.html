{% extends "detail_page.html" %}

{% block title %}Team Comparison{% endblock %}
{% block page_title %}Team Comparison{% endblock %}

{% block header_title %}Team Comparison{% endblock %}

{% block page_description %}
<div style="font-size: 1.2em; color: var(--text-secondary); margin-bottom: 15px;">
    Cross-Team Performance Analysis
</div>
{% endblock %}

{% block period_info %}
ðŸ“Š Comparing last {{ config.days_back if config else 90 }} days
{% endblock %}

{% block breadcrumb_items %}
<a href="/comparison">Team Comparison</a>
{% endblock %}

{% block main_content %}
<div class="card">
            <h2>GitHub Metrics Comparison</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Side-by-side comparison of GitHub activity metrics between teams. The winning team for each metric is highlighted in green.
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th class="team-native">Native</th>
                        <th class="team-webtc">WebTC</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Pull Requests</strong></td>
                        <td {% if comparison.Native.prs > comparison.WebTC.prs %}class="winner"{% endif %}>
                            {{ comparison.Native.prs }}
                        </td>
                        <td {% if comparison.WebTC.prs > comparison.Native.prs %}class="winner"{% endif %}>
                            {{ comparison.WebTC.prs }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Code Reviews</strong></td>
                        <td {% if comparison.Native.reviews > comparison.WebTC.reviews %}class="winner"{% endif %}>
                            {{ comparison.Native.reviews }}
                        </td>
                        <td {% if comparison.WebTC.reviews > comparison.Native.reviews %}class="winner"{% endif %}>
                            {{ comparison.WebTC.reviews }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Commits</strong></td>
                        <td {% if comparison.Native.commits > comparison.WebTC.commits %}class="winner"{% endif %}>
                            {{ comparison.Native.commits }}
                        </td>
                        <td {% if comparison.WebTC.commits > comparison.Native.commits %}class="winner"{% endif %}>
                            {{ comparison.WebTC.commits }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Avg PR Cycle Time</strong></td>
                        <td {% if comparison.Native.avg_cycle_time < comparison.WebTC.avg_cycle_time and comparison.Native.avg_cycle_time > 0 %}class="winner"{% endif %}>
                            {{ "%.1f"|format(comparison.Native.avg_cycle_time) }}h
                        </td>
                        <td {% if comparison.WebTC.avg_cycle_time < comparison.Native.avg_cycle_time and comparison.WebTC.avg_cycle_time > 0 %}class="winner"{% endif %}>
                            {{ "%.1f"|format(comparison.WebTC.avg_cycle_time) }}h
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 style="margin: 30px 0 15px 0; font-size: 20px;">Visual Comparison</h2>
        <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 0 0 20px 0; line-height: 1.4;">
            Visual comparison of team performance across key GitHub metrics. Charts show relative volumes and efficiency between teams.
        </p>

        <div class="comparison-grid">
            <div class="card">
                <h2>Pull Requests</h2>
                <div id="pr-comparison"></div>
            </div>

            <div class="card">
                <h2>Code Reviews</h2>
                <div id="review-comparison"></div>
            </div>

            <div class="card">
                <h2>Commits</h2>
                <div id="commit-comparison"></div>
            </div>

            <div class="card">
                <h2>PR Cycle Time</h2>
                <div id="cycle-time-comparison"></div>
            </div>
        </div>

        <script>
            // Get theme-aware colors
            function getChartColors() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                return {
                    paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    font_color: isDark ? '#e0e0e0' : '#2c3e50',
                    grid_color: isDark ? '#444' : '#ecf0f1'
                };
            }

            // Common layout configuration
            function getChartLayout(title, yaxisTitle) {
                const colors = getChartColors();
                return {
                    title: {
                        text: title,
                        font: {size: 14}
                    },
                    yaxis: {
                        title: yaxisTitle,
                        gridcolor: colors.grid_color,
                        color: colors.font_color,
                        showticklabels: true,
                        tickfont: {size: 11}
                    },
                    xaxis: {
                        color: colors.font_color,
                        showticklabels: true,
                        tickfont: {size: 11},
                        tickangle: -45
                    },
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color, size: 11},
                    width: 600,
                    height: 400,
                    margin: {l: 60, r: 30, t: 50, b: 100},
                    autosize: false
                };
            }

            // Common config
            const config = {responsive: false, displayModeBar: false};

            // PR Chart
            Plotly.newPlot('pr-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.prs }}, {{ comparison.WebTC.prs }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Pull Requests by Team', 'Number of PRs'), config);

            // Review Chart
            Plotly.newPlot('review-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.reviews }}, {{ comparison.WebTC.reviews }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Reviews by Team', 'Number of Reviews'), config);

            // Commits Chart
            Plotly.newPlot('commit-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.commits }}, {{ comparison.WebTC.commits }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Commits by Team', 'Number of Commits'), config);

            // Cycle Time Chart
            Plotly.newPlot('cycle-time-comparison', [{
                x: ['Native', 'WebTC'],
                y: [{{ comparison.Native.avg_cycle_time }}, {{ comparison.WebTC.avg_cycle_time }}],
                type: 'bar',
                marker: {color: ['#3498db', '#9b59b6']},
                width: [0.4, 0.4]
            }], getChartLayout('Avg PR Cycle Time (Lower is Better)', 'Hours'), config);
        </script>

        {% if comparison.Native.jira_throughput or comparison.WebTC.jira_throughput %}
        <div class="card">
            <h2>Jira Metrics Comparison</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Side-by-side comparison of Jira delivery metrics between teams. Higher throughput and lower WIP generally indicate better flow.
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th class="team-native">Native</th>
                        <th class="team-webtc">WebTC</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Throughput (issues/week)</strong></td>
                        <td {% if comparison.Native.jira_throughput > comparison.WebTC.jira_throughput %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['Native'].jira.filters.completed_12weeks }}"
                               target="_blank"
                               style="color: inherit; text-decoration: underline;">
                                {{ "%.1f"|format(comparison.Native.jira_throughput) }}
                            </a>
                        </td>
                        <td {% if comparison.WebTC.jira_throughput > comparison.Native.jira_throughput %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['WebTC'].jira.filters.completed_12weeks }}"
                               target="_blank"
                               style="color: inherit; text-decoration: underline;">
                                {{ "%.1f"|format(comparison.WebTC.jira_throughput) }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>WIP Count</strong></td>
                        <td>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['Native'].jira.filters.wip }}"
                               target="_blank"
                               style="color: inherit; text-decoration: underline;">
                                {{ comparison.Native.jira_wip }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['WebTC'].jira.filters.wip }}"
                               target="_blank"
                               style="color: inherit; text-decoration: underline;">
                                {{ comparison.WebTC.jira_wip }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Flagged/Blocked</strong></td>
                        <td {% if comparison.Native.jira_flagged < comparison.WebTC.jira_flagged %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['Native'].jira.filters.flagged_blocked }}"
                               target="_blank"
                               style="color: inherit; text-decoration: underline;">
                                {{ comparison.Native.jira_flagged }}
                            </a>
                        </td>
                        <td {% if comparison.WebTC.jira_flagged < comparison.Native.jira_flagged %}class="winner"{% endif %}>
                            <a href="{{ jira_server }}/issues/?filter={{ team_configs['WebTC'].jira.filters.flagged_blocked }}"
                               target="_blank"
                               style="color: inherit; text-decoration: underline;">
                                {{ comparison.WebTC.jira_flagged }}
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Jira Charts Section -->
        {% for team_name in ['Native', 'WebTC'] %}
        {% if teams[team_name] and teams[team_name].jira %}

        <!-- Throughput by Type -->
        {% if teams[team_name].jira.throughput and teams[team_name].jira.throughput.by_type %}
        <div class="card">
            <h2>{{ teams[team_name].display_name }} - Throughput by Type</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Distribution of completed work by issue type over 12 weeks. Shows what types of work the team delivers.
            </p>
            <div id="throughput-types-{{ team_name }}-chart" style="height: 400px;"></div>
            <script>
                (function() {
                const typeData = {{ teams[team_name].jira.throughput.by_type | tojson }};
                const colors = getChartColors();

                Plotly.newPlot('throughput-types-{{ team_name }}-chart', [{
                    labels: Object.keys(typeData),
                    values: Object.values(typeData),
                    type: 'pie',
                    marker: {
                        colors: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                }], {
                    paper_bgcolor: colors.paper_bgcolor,
                    font: {color: colors.font_color},
                    showlegend: true,
                    height: 400
                }, {responsive: true});
                })();
            </script>
        </div>
        {% endif %}

        <!-- WIP Age Distribution -->
        {% if teams[team_name].jira.wip and teams[team_name].jira.wip.age_distribution %}
        <div class="card">
            <h2>{{ teams[team_name].display_name }} - WIP Age Distribution</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                How long current WIP items have been in progress. Items in WIP longer may need attention.
            </p>
            <div id="wip-age-{{ team_name }}-chart"></div>
            <script>
                (function() {
                const colors = getChartColors();
                var data = [{
                    x: Object.keys({{ teams[team_name].jira.wip.age_distribution|tojson }}),
                    y: Object.values({{ teams[team_name].jira.wip.age_distribution|tojson }}),
                    type: 'bar',
                    marker: {color: '#3498db'}
                }];

                var layout = {
                    title: 'Days in WIP Status',
                    xaxis: {
                        title: 'Age Range',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    yaxis: {
                        title: 'Number of Issues',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color},
                    height: 300
                };
                Plotly.newPlot('wip-age-{{ team_name }}-chart', data, layout);
                })();
            </script>
        </div>
        {% endif %}

        <!-- WIP by Status -->
        {% if teams[team_name].jira.wip and teams[team_name].jira.wip.by_status %}
        <div class="card">
            <h2>{{ teams[team_name].display_name }} - WIP by Status</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Breakdown of current work in progress by status. Helps identify bottlenecks.
            </p>
            <div id="wip-status-{{ team_name }}-chart" style="height: 400px;"></div>
            <script>
                (function() {
                const statusData = {{ teams[team_name].jira.wip.by_status | tojson }};
                const colors = getChartColors();

                Plotly.newPlot('wip-status-{{ team_name }}-chart', [{
                    x: Object.values(statusData),
                    y: Object.keys(statusData),
                    type: 'bar',
                    orientation: 'h',
                    marker: {color: '#3498db'}
                }], {
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color},
                    xaxis: {
                        title: 'Number of Issues',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    yaxis: {
                        title: '',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    height: 400,
                    margin: {l: 200, r: 30, t: 30, b: 50}
                }, {responsive: true});
                })();
            </script>
        </div>
        {% endif %}

        <!-- Bugs Trend -->
        {% if teams[team_name].jira.bugs and teams[team_name].jira.bugs.trend_created %}
        <div class="card">
            <h2>{{ teams[team_name].display_name }} - Bugs Trend</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Top: Bug creation vs resolution trends. Bottom: Net difference. Positive trends indicate bug backlog growth.
            </p>
            <div id="bugs-trend-{{ team_name }}-chart" style="height: 600px;"></div>
            <script>
                (function() {
                const bugsCreated = {{ teams[team_name].jira.bugs.trend_created | tojson }};
                const bugsResolved = {{ teams[team_name].jira.bugs.trend_resolved | tojson }};
                const colors = getChartColors();

                const allWeeks = [...new Set([...Object.keys(bugsCreated), ...Object.keys(bugsResolved)])].sort();
                const netDifference = allWeeks.map(w => (bugsCreated[w] || 0) - (bugsResolved[w] || 0));

                Plotly.newPlot('bugs-trend-{{ team_name }}-chart', [
                    {
                        x: allWeeks,
                        y: allWeeks.map(w => bugsCreated[w] || 0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Created',
                        line: {color: '#e74c3c', width: 2},
                        marker: {color: '#e74c3c', size: 6},
                        xaxis: 'x',
                        yaxis: 'y'
                    },
                    {
                        x: allWeeks,
                        y: allWeeks.map(w => bugsResolved[w] || 0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Resolved',
                        line: {color: '#2ecc71', width: 2},
                        marker: {color: '#2ecc71', size: 6},
                        xaxis: 'x',
                        yaxis: 'y'
                    },
                    {
                        x: allWeeks,
                        y: netDifference,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Net (Created - Resolved)',
                        line: {color: '#3498db', width: 2},
                        marker: {color: '#3498db', size: 6},
                        xaxis: 'x2',
                        yaxis: 'y2'
                    }
                ], {
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color},
                    grid: {rows: 2, columns: 1, pattern: 'independent', roworder: 'top to bottom'},
                    xaxis: {
                        title: '',
                        gridcolor: colors.grid_color,
                        color: colors.font_color,
                        showticklabels: false
                    },
                    yaxis: {
                        title: 'Count',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    xaxis2: {
                        title: 'Week',
                        gridcolor: colors.grid_color,
                        color: colors.font_color,
                        anchor: 'y2'
                    },
                    yaxis2: {
                        title: 'Net Difference',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    showlegend: true,
                    height: 600,
                    legend: {
                        x: 0.5,
                        xanchor: 'center',
                        y: 1.02,
                        yanchor: 'bottom',
                        orientation: 'h'
                    }
                }, {responsive: true});
                })();
            </script>
        </div>
        {% endif %}

        <!-- Scope Trend -->
        {% if teams[team_name].jira.scope and teams[team_name].jira.scope.trend_created %}
        <div class="card">
            <h2>{{ teams[team_name].display_name }} - Scope Trend</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Top: Scope item creation vs completion. Bottom: Net difference. Shows whether scope is growing or being worked down.
            </p>
            <div id="scope-trend-{{ team_name }}-chart" style="height: 600px;"></div>
            <script>
                (function() {
                const scopeCreated = {{ teams[team_name].jira.scope.trend_created | tojson }};
                const scopeResolved = {{ teams[team_name].jira.scope.trend_resolved | tojson }};
                const colors = getChartColors();

                const allWeeksScope = [...new Set([...Object.keys(scopeCreated), ...Object.keys(scopeResolved)])].sort();
                const netDifferenceScope = allWeeksScope.map(w => (scopeCreated[w] || 0) - (scopeResolved[w] || 0));

                Plotly.newPlot('scope-trend-{{ team_name }}-chart', [
                    {
                        x: allWeeksScope,
                        y: allWeeksScope.map(w => scopeCreated[w] || 0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Created',
                        line: {color: CHART_COLORS.CREATED, width: 2},
                        marker: {color: CHART_COLORS.CREATED, size: 6},
                        xaxis: 'x',
                        yaxis: 'y'
                    },
                    {
                        x: allWeeksScope,
                        y: allWeeksScope.map(w => scopeResolved[w] || 0),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Resolved',
                        line: {color: CHART_COLORS.RESOLVED, width: 2},
                        marker: {color: CHART_COLORS.RESOLVED, size: 6},
                        xaxis: 'x',
                        yaxis: 'y'
                    },
                    {
                        x: allWeeksScope,
                        y: netDifferenceScope,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Net (Created - Resolved)',
                        line: {color: CHART_COLORS.NET, width: 2},
                        marker: {color: CHART_COLORS.NET, size: 6},
                        xaxis: 'x2',
                        yaxis: 'y2'
                    }
                ], {
                    paper_bgcolor: colors.paper_bgcolor,
                    plot_bgcolor: colors.plot_bgcolor,
                    font: {color: colors.font_color},
                    grid: {rows: 2, columns: 1, pattern: 'independent', roworder: 'top to bottom'},
                    xaxis: {
                        title: '',
                        gridcolor: colors.grid_color,
                        color: colors.font_color,
                        showticklabels: false
                    },
                    yaxis: {
                        title: 'Count',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    xaxis2: {
                        title: 'Week',
                        gridcolor: colors.grid_color,
                        color: colors.font_color,
                        anchor: 'y2'
                    },
                    yaxis2: {
                        title: 'Net Difference',
                        gridcolor: colors.grid_color,
                        color: colors.font_color
                    },
                    showlegend: true,
                    height: 600,
                    legend: {
                        x: 0.5,
                        xanchor: 'center',
                        y: 1.02,
                        yanchor: 'bottom',
                        orientation: 'h'
                    }
                }, {responsive: true});
                })();
            </script>
        </div>
        {% endif %}

        <!-- Flagged/Blocked Issues Table -->
        {% if teams[team_name].jira.flagged and teams[team_name].jira.flagged.issues %}
        <div class="card">
            <h2>{{ teams[team_name].display_name }} - Flagged/Blocked Issues</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Issues currently flagged or blocked. Prioritize removing blockers to maintain team flow.
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Issue</th>
                        <th>Summary</th>
                        <th>Assignee</th>
                        <th>Days Blocked</th>
                    </tr>
                </thead>
                <tbody>
                    {% for issue in teams[team_name].jira.flagged.issues %}
                    <tr>
                        <td>
                            <strong>
                                <a href="{{ jira_server }}/browse/{{ issue.key }}" target="_blank" style="color: #3498db; text-decoration: none;">
                                    {{ issue.key }} ðŸ”—
                                </a>
                            </strong>
                        </td>
                        <td>{{ issue.summary[:60] }}...</td>
                        <td>{{ issue.assignee }}</td>
                        <td class="attention">{{ issue.days_blocked }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% endif %}
        {% endfor %}
    </div>
{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ username }} - Metrics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
</head>
<body>
    <button onclick="toggleTheme()" class="theme-toggle">üåô Dark Mode</button>
    <div class="container">
        <header>
            <h1>{{ username }}</h1>
            {% if team_name %}
            <p class="subtitle">Team: {{ team_name }}</p>
            {% endif %}
            <p class="subtitle">Period: {{ person_data.period.start[:10] if person_data.period.start else 'N/A' }} to {{ person_data.period.end[:10] if person_data.period.end else 'N/A' }}</p>
            <p class="subtitle">Last updated: {{ updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>

            <!-- Date Range Selector -->
            <div class="date-selector" style="text-align: center; margin: 20px 0;">
                <label for="period-select" style="margin-right: 10px; font-weight: 600; color: var(--text-primary);">Select Period:</label>
                <select id="period-select" onchange="changePeriod()" style="padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;">
                    <option value="30d" {% if period == '30d' %}selected{% endif %}>Last 30 Days</option>
                    <option value="90d" {% if period == '90d' %}selected{% endif %}>Last 90 Days</option>
                    <option value="180d" {% if period == '180d' %}selected{% endif %}>Last 180 Days</option>
                    <option value="365d" {% if period == '365d' %}selected{% endif %}>Last 365 Days</option>
                    <option value="Q1-2025" {% if period == 'Q1-2025' %}selected{% endif %}>Q1 2025</option>
                    <option value="Q2-2025" {% if period == 'Q2-2025' %}selected{% endif %}>Q2 2025</option>
                    <option value="Q3-2025" {% if period == 'Q3-2025' %}selected{% endif %}>Q3 2025</option>
                    <option value="Q4-2025" {% if period == 'Q4-2025' %}selected{% endif %}>Q4 2025</option>
                </select>
            </div>

            <script>
            function changePeriod() {
                const period = document.getElementById('period-select').value;
                const url = new URL(window.location);
                url.searchParams.set('period', period);
                window.location.href = url.toString();
            }
            </script>

            <div class="nav">
                <a href="/">‚Üê Home</a>
                {% if team_name %}
                <a href="/team/{{ team_name }}">{{ team_name }} Team</a>
                {% endif %}
            </div>
        </header>

        <h2 class="section-title">GitHub Activity</h2>
        <div class="metrics-grid">
            <div class="card">
                <h2>Pull Requests</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Number of pull requests authored during this period. The merge rate shows what percentage of PRs were successfully merged into the main branch.
                </p>
                <div class="metric-value">{{ person_data.github.prs_created }}</div>
                <div class="metric-label">PRs Created</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    Merged: {{ person_data.github.prs_merged }} ({{ "%.0f"|format(person_data.github.merge_rate * 100) }}%)
                </div>
            </div>

            <div class="card">
                <h2>Code Reviews</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Total number of review comments provided on other team members' pull requests. Measures participation in code review and collaboration.
                </p>
                <div class="metric-value">{{ person_data.github.reviews_given }}</div>
                <div class="metric-label">Reviews Given</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    PRs reviewed: {{ person_data.github.prs_reviewed }}
                </div>
            </div>

            <div class="card">
                <h2>Commits</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Total commits pushed to the repository. Each commit represents a saved change to the codebase.
                </p>
                <div class="metric-value">{{ person_data.github.commits }}</div>
                <div class="metric-label">Total Commits</div>
            </div>

            <div class="card">
                <h2>Code Changes</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Total lines of code added or removed across all commits. This gives a rough measure of code contribution volume.
                </p>
                <div class="metric-value">{{ person_data.github.lines_added + person_data.github.lines_deleted }}</div>
                <div class="metric-label">Total Lines Changed</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    +{{ person_data.github.lines_added }} / -{{ person_data.github.lines_deleted }}
                </div>
            </div>

            <div class="card">
                <h2>PR Cycle Time</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Average time from PR creation to merge. Lower cycle times indicate faster development throughput and efficient review processes.
                </p>
                <div class="metric-value">{{ "%.1f"|format(person_data.github.avg_pr_cycle_time) }}h</div>
                <div class="metric-label">Avg Time to Merge</div>
            </div>

            <div class="card">
                <h2>Review Speed</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Average time from review request to first review comment. Lower times indicate more responsive code review.
                </p>
                <div class="metric-value">{{ "%.1f"|format(person_data.github.avg_time_to_review) }}h</div>
                <div class="metric-label">Avg Time to First Review</div>
            </div>
        </div>

        <!-- Trend Charts Section -->
        {% if person_data.trends %}
        <h2 class="section-title" style="margin-top: 40px;">Activity Trends</h2>

        <div class="card">
            <h3>Pull Requests Over Time</h3>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Weekly trend of pull requests created. Shows consistency of code contributions and development activity over time.
            </p>
            <div id="pr-trend-chart"></div>
            <script>
                const prTrendData = {{ person_data.trends.pr_trend|tojson }};
                if (prTrendData && prTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('pr-trend-chart', [{
                        x: prTrendData.map(d => d.period),
                        y: prTrendData.map(d => d.count),
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: {color: '#3498db', size: 8},
                        line: {color: '#3498db', width: 2}
                    }], {
                        yaxis: {
                            title: 'Number of PRs',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>

        <div class="card">
            <h3>Code Reviews Over Time</h3>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Weekly trend of code reviews given. Measures ongoing participation in code review and collaboration activities.
            </p>
            <div id="review-trend-chart"></div>
            <script>
                const reviewTrendData = {{ person_data.trends.review_trend|tojson }};
                if (reviewTrendData && reviewTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('review-trend-chart', [{
                        x: reviewTrendData.map(d => d.period),
                        y: reviewTrendData.map(d => d.count),
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: {color: '#9b59b6', size: 8},
                        line: {color: '#9b59b6', width: 2}
                    }], {
                        yaxis: {
                            title: 'Number of Reviews',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>

        <div class="card">
            <h3>Commits Over Time</h3>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Weekly commit activity. Indicates the frequency and consistency of code contributions throughout the period.
            </p>
            <div id="commit-trend-chart"></div>
            <script>
                const commitTrendData = {{ person_data.trends.commit_trend|tojson }};
                if (commitTrendData && commitTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('commit-trend-chart', [{
                        x: commitTrendData.map(d => d.period),
                        y: commitTrendData.map(d => d.count),
                        type: 'bar',
                        marker: {color: '#27ae60'}
                    }], {
                        yaxis: {
                            title: 'Number of Commits',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>

        <div class="card">
            <h3>Code Changes Over Time</h3>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Code additions (green) and deletions (red) by week. Large spikes may indicate major features or refactoring efforts.
            </p>
            <div id="lines-trend-chart"></div>
            <script>
                const linesTrendData = {{ person_data.trends.lines_changed_trend|tojson }};
                if (linesTrendData && linesTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('lines-trend-chart', [
                        {
                            x: linesTrendData.map(d => d.period),
                            y: linesTrendData.map(d => d.additions),
                            type: 'bar',
                            name: 'Additions',
                            marker: {color: '#27ae60'}
                        },
                        {
                            x: linesTrendData.map(d => d.period),
                            y: linesTrendData.map(d => d.deletions),
                            type: 'bar',
                            name: 'Deletions',
                            marker: {color: '#e74c3c'}
                        }
                    ], {
                        yaxis: {
                            title: 'Lines of Code',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        barmode: 'group',
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>
        {% endif %}

        {% if person_data.jira and person_data.jira.completed > 0 %}
        <h2 class="section-title">Jira Activity</h2>
        <div class="metrics-grid">
            <div class="card">
                <h2>Issues Completed</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Total Jira issues resolved during this period. Represents completed work items assigned to this person.
                </p>
                <div class="metric-value">{{ person_data.jira.completed }}</div>
                <div class="metric-label">Resolved Issues</div>
            </div>

            <div class="card">
                <h2>Work In Progress</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Number of Jira issues currently in progress. Shows the active workload for this person.
                </p>
                <div class="metric-value">{{ person_data.jira.in_progress }}</div>
                <div class="metric-label">Active Issues</div>
            </div>

            <div class="card">
                <h2>Avg Cycle Time</h2>
                <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                    Average time from when an issue was started to when it was resolved. Lower cycle times indicate faster issue completion.
                </p>
                <div class="metric-value">{{ "%.1f"|format(person_data.jira.avg_cycle_time) }}h</div>
                <div class="metric-label">Issue Resolution Time</div>
            </div>
        </div>

        {% if person_data.jira.types %}
        <div class="card">
            <h2>Issue Types</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Distribution of completed and in-progress issues by type. Shows the mix of work handled (bugs, features, tasks, etc.).
            </p>
            <div id="issue-types-chart"></div>
            <script>
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const chartColors = {
                    paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    font_color: isDark ? '#e0e0e0' : '#2c3e50',
                    grid_color: isDark ? '#444' : '#ecf0f1'
                };

                var data = [{
                    labels: Object.keys({{ person_data.jira.types|tojson }}),
                    values: Object.values({{ person_data.jira.types|tojson }}),
                    type: 'pie',
                    marker: {colors: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6']}
                }];
                var layout = {
                    title: 'Issues by Type',
                    height: 300,
                    paper_bgcolor: chartColors.paper_bgcolor,
                    plot_bgcolor: chartColors.plot_bgcolor,
                    font: {color: chartColors.font_color}
                };
                Plotly.newPlot('issue-types-chart', data, layout);
            </script>
        </div>
        {% endif %}
        {% endif %}

        <div class="card" style="margin-top: 30px;">
            <h2>Activity Summary</h2>
            <p style="line-height: 1.6; color: var(--text-primary);">
                <strong>{{ username }}</strong> contributed to the team during this period.
                {% if person_data.github.prs_created > 0 %}
                Created <strong>{{ person_data.github.prs_created }}</strong> pull requests with a
                <strong>{{ "%.0f"|format(person_data.github.merge_rate * 100) }}%</strong> merge rate.
                {% endif %}
                {% if person_data.github.reviews_given > 0 %}
                Provided <strong>{{ person_data.github.reviews_given }}</strong> code reviews across
                <strong>{{ person_data.github.prs_reviewed }}</strong> different pull requests.
                {% endif %}
                {% if person_data.github.commits > 0 %}
                Made <strong>{{ person_data.github.commits }}</strong> commits, contributing
                <strong>+{{ person_data.github.lines_added }}</strong> and removing
                <strong>-{{ person_data.github.lines_deleted }}</strong> lines of code.
                {% endif %}
                {% if person_data.jira and person_data.jira.completed > 0 %}
                Completed <strong>{{ person_data.jira.completed }}</strong> Jira issues with an average cycle time of <strong>{{ "%.1f"|format(person_data.jira.avg_cycle_time) }}</strong> hours.
                {% endif %}
                {% if person_data.jira and person_data.jira.in_progress > 0 %}
                Had <strong>{{ person_data.jira.in_progress }}</strong> issues in progress during this period.
                {% endif %}
            </p>
        </div>
    </div>
</body>
</html>

{% extends "detail_page.html" %}

{% block title %}{{ display_name }} - Metrics{% endblock %}
{% block page_title %}{{ display_name }} - Metrics{% endblock %}

{% block header_title %}{{ display_name }}{% endblock %}

{% block page_description %}
<div class="page-description">
    Individual Contributor Metrics
</div>
{% endblock %}

{% block data_freshness %}
{% if updated_at %}
<div style="text-align: center; margin-top: 5px; margin-bottom: 15px;">
    <span style="display: inline-block; padding: 4px 12px; background: var(--bg-tertiary); color: var(--text-secondary); border-radius: 12px; font-size: 0.85em; border: 1px solid var(--border-color);">
        ðŸ“… Data from {{ updated_at|time_ago }}
    </span>
</div>
{% endif %}
{% endblock %}

{% block period_info %}
    {% if team_name %}
    <div class="text-sm" style="margin-bottom: 5px; color: var(--text-secondary);">Team: {{ team_name }}</div>
    {% endif %}
    <div class="text-sm" style="color: var(--text-secondary);">ðŸ“… Period: {{ person_data.period.start[:10] if person_data.period.start else 'N/A' }} to {{ person_data.period.end[:10] if person_data.period.end else 'N/A' }}</div>
{% endblock %}

{% block header_meta %}
{% endblock %}

{% block breadcrumb_items %}
{% if team_name %}
<a href="/team/{{ team_name }}">{{ team_name }} Team</a>
{% endif %}
<a href="/person/{{ username|e }}">{{ display_name }}</a>
{% endblock %}

{% block extra_js %}
{% endblock %}

{% block main_content %}
<div class="person-dashboard-container">

<!-- Export Buttons -->
<div class="export-buttons">
    <a href="/api/export/person/{{ username|e }}/csv" class="btn-export" download>
        ðŸ“Š Export CSV
    </a>
    <a href="/api/export/person/{{ username|e }}/json" class="btn-export" download>
        ðŸ“‹ Export JSON
    </a>
</div>

        <h2 class="section-title">GitHub Activity</h2>
        <div class="metrics-grid">
            <div class="card">
                <h2>Pull Requests</h2>
                <p class="helper-text">
                    Number of pull requests authored during this period. The merge rate shows what percentage of PRs were successfully merged into the main branch.
                </p>
                <div class="metric-value">{{ person_data.github.prs_created }}</div>
                <div class="metric-label">PRs Created</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    Merged: {{ person_data.github.prs_merged }} ({{ "%.0f"|format(person_data.github.merge_rate * 100) }}%)
                </div>
            </div>

            <div class="card">
                <h2>Code Reviews</h2>
                <p class="helper-text">
                    Total number of review comments provided on other team members' pull requests. Measures participation in code review and collaboration.
                </p>
                <div class="metric-value">{{ person_data.github.reviews_given }}</div>
                <div class="metric-label">Reviews Given</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    PRs reviewed: {{ person_data.github.prs_reviewed }}
                </div>
            </div>

            <div class="card">
                <h2>Commits</h2>
                <p class="helper-text">
                    Total commits pushed to the repository. Each commit represents a saved change to the codebase.
                </p>
                <div class="metric-value">{{ person_data.github.commits }}</div>
                <div class="metric-label">Total Commits</div>
            </div>

            <div class="card">
                <h2>Code Changes</h2>
                <p class="helper-text">
                    Total lines of code added or removed across all commits. This gives a rough measure of code contribution volume.
                </p>
                <div class="metric-value">{{ person_data.github.lines_added + person_data.github.lines_deleted }}</div>
                <div class="metric-label">Total Lines Changed</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    +{{ person_data.github.lines_added }} / -{{ person_data.github.lines_deleted }}
                </div>
            </div>

            <div class="card">
                <h2>PR Cycle Time</h2>
                <p class="helper-text">
                    Average time from PR creation to merge. Lower cycle times indicate faster development throughput and efficient review processes.
                </p>
                <div class="metric-value">{{ "%.1f"|format(person_data.github.avg_pr_cycle_time) }}h</div>
                <div class="metric-label">Avg Time to Merge</div>
            </div>

            <div class="card">
                <h2>Review Speed</h2>
                <p class="helper-text">
                    Average time from review request to first review comment. Lower times indicate more responsive code review.
                </p>
                <div class="metric-value">{{ "%.1f"|format(person_data.github.avg_time_to_review) }}h</div>
                <div class="metric-label">Avg Time to First Review</div>
            </div>
        </div>

        <!-- Trend Charts Section -->
        {% if person_data.trends %}
        <h2 class="section-title" style="margin-top: 40px;">Activity Trends</h2>

        <div class="card">
            <h3>Pull Requests Over Time</h3>
            <p class="helper-text">
                Weekly trend of pull requests created. Shows consistency of code contributions and development activity over time.
            </p>
            <div id="pr-trend-chart"></div>
            <script>
                const prTrendData = {{ person_data.trends.pr_trend|tojson }};
                if (prTrendData && prTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('pr-trend-chart', [{
                        x: prTrendData.map(d => d.period),
                        y: prTrendData.map(d => d.count),
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: {color: '#3498db', size: 8},
                        line: {color: '#3498db', width: 2}
                    }], {
                        yaxis: {
                            title: 'Number of PRs',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>

        <div class="card">
            <h3>Code Reviews Over Time</h3>
            <p class="helper-text">
                Weekly trend of code reviews given. Measures ongoing participation in code review and collaboration activities.
            </p>
            <div id="review-trend-chart"></div>
            <script>
                const reviewTrendData = {{ person_data.trends.review_trend|tojson }};
                if (reviewTrendData && reviewTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('review-trend-chart', [{
                        x: reviewTrendData.map(d => d.period),
                        y: reviewTrendData.map(d => d.count),
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: {color: '#9b59b6', size: 8},
                        line: {color: '#9b59b6', width: 2}
                    }], {
                        yaxis: {
                            title: 'Number of Reviews',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>

        <div class="card">
            <h3>Commits Over Time</h3>
            <p class="helper-text">
                Weekly commit activity. Indicates the frequency and consistency of code contributions throughout the period.
            </p>
            <div id="commit-trend-chart"></div>
            <script>
                const commitTrendData = {{ person_data.trends.commit_trend|tojson }};
                if (commitTrendData && commitTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('commit-trend-chart', [{
                        x: commitTrendData.map(d => d.period),
                        y: commitTrendData.map(d => d.count),
                        type: 'bar',
                        marker: {color: '#27ae60'}
                    }], {
                        yaxis: {
                            title: 'Number of Commits',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>

        <div class="card">
            <h3>Code Changes Over Time</h3>
            <p class="helper-text">
                Code additions (green) and deletions (red) by week. Large spikes may indicate major features or refactoring efforts.
            </p>
            <div id="lines-trend-chart"></div>
            <script>
                const linesTrendData = {{ person_data.trends.lines_changed_trend|tojson }};
                if (linesTrendData && linesTrendData.length > 0) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const chartColors = {
                        paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                        font_color: isDark ? '#e0e0e0' : '#2c3e50',
                        grid_color: isDark ? '#444' : '#ecf0f1'
                    };

                    Plotly.newPlot('lines-trend-chart', [
                        {
                            x: linesTrendData.map(d => d.period),
                            y: linesTrendData.map(d => d.additions),
                            type: 'bar',
                            name: 'Additions',
                            marker: {color: '#27ae60'}
                        },
                        {
                            x: linesTrendData.map(d => d.period),
                            y: linesTrendData.map(d => d.deletions),
                            type: 'bar',
                            name: 'Deletions',
                            marker: {color: '#e74c3c'}
                        }
                    ], {
                        yaxis: {
                            title: 'Lines of Code',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color
                        },
                        xaxis: {
                            title: 'Period',
                            gridcolor: chartColors.grid_color,
                            color: chartColors.font_color,
                            tickangle: -45
                        },
                        paper_bgcolor: chartColors.paper_bgcolor,
                        plot_bgcolor: chartColors.plot_bgcolor,
                        font: {color: chartColors.font_color},
                        barmode: 'group',
                        height: 300,
                        margin: {l: 60, r: 30, t: 20, b: 100}
                    }, {responsive: true, displayModeBar: false});
                }
            </script>
        </div>
        {% endif %}

        {% if person_data.jira and person_data.jira.completed > 0 %}
        <h2 class="section-title">Jira Activity</h2>
        <div class="metrics-grid">
            <div class="card">
                <h2>Issues Completed</h2>
                <p class="helper-text">
                    Total Jira issues resolved during this period. Represents completed work items assigned to this person.
                </p>
                <div class="metric-value">{{ person_data.jira.completed }}</div>
                <div class="metric-label">Resolved Issues</div>
            </div>

            <div class="card">
                <h2>Work In Progress</h2>
                <p class="helper-text">
                    Number of Jira issues currently in progress. Shows the active workload for this person.
                </p>
                <div class="metric-value">{{ person_data.jira.in_progress }}</div>
                <div class="metric-label">Active Issues</div>
            </div>

            <div class="card">
                <h2>Avg Cycle Time</h2>
                <p class="helper-text">
                    Average time from when an issue was started to when it was resolved. Lower cycle times indicate faster issue completion.
                </p>
                <div class="metric-value">{{ "%.1f"|format(person_data.jira.avg_cycle_time) }}h</div>
                <div class="metric-label">Issue Resolution Time</div>
            </div>
        </div>

        {% if person_data.jira.types %}
        <div class="card">
            <h2>Issue Types</h2>
            <p class="helper-text">
                Distribution of completed and in-progress issues by type. Shows the mix of work handled (bugs, features, tasks, etc.).
            </p>
            <div id="issue-types-chart"></div>
            <script>
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const chartColors = {
                    paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    font_color: isDark ? '#e0e0e0' : '#2c3e50',
                    grid_color: isDark ? '#444' : '#ecf0f1'
                };

                var data = [{
                    labels: Object.keys({{ person_data.jira.types|tojson }}),
                    values: Object.values({{ person_data.jira.types|tojson }}),
                    type: 'pie',
                    marker: {colors: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6']}
                }];
                var layout = {
                    title: 'Issues by Type',
                    height: 300,
                    paper_bgcolor: chartColors.paper_bgcolor,
                    plot_bgcolor: chartColors.plot_bgcolor,
                    font: {color: chartColors.font_color}
                };
                Plotly.newPlot('issue-types-chart', data, layout);
            </script>
        </div>
        {% endif %}
        {% endif %}

        <div class="card" style="margin-top: 30px;">
            <h2>Activity Summary</h2>
            <p style="line-height: 1.6; color: var(--text-primary);">
                <strong>{{ username }}</strong> contributed to the team during this period.
                {% if person_data.github.prs_created > 0 %}
                Created <strong>{{ person_data.github.prs_created }}</strong> pull requests with a
                <strong>{{ "%.0f"|format(person_data.github.merge_rate * 100) }}%</strong> merge rate.
                {% endif %}
                {% if person_data.github.reviews_given > 0 %}
                Provided <strong>{{ person_data.github.reviews_given }}</strong> code reviews across
                <strong>{{ person_data.github.prs_reviewed }}</strong> different pull requests.
                {% endif %}
                {% if person_data.github.commits > 0 %}
                Made <strong>{{ person_data.github.commits }}</strong> commits, contributing
                <strong>+{{ person_data.github.lines_added }}</strong> and removing
                <strong>-{{ person_data.github.lines_deleted }}</strong> lines of code.
                {% endif %}
                {% if person_data.jira and person_data.jira.completed > 0 %}
                Completed <strong>{{ person_data.jira.completed }}</strong> Jira issues with an average cycle time of <strong>{{ "%.1f"|format(person_data.jira.avg_cycle_time) }}</strong> hours.
                {% endif %}
                {% if person_data.jira and person_data.jira.in_progress > 0 %}
                Had <strong>{{ person_data.jira.in_progress }}</strong> issues in progress during this period.
                {% endif %}
            </p>
        </div>
    </div>

</div> <!-- End of person-dashboard-container -->
{% endblock %}

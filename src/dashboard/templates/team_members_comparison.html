{% extends "detail_page.html" %}

{% block title %}{{ team_display_name }} - Member Comparison{% endblock %}
{% block page_title %}{{ team_display_name }} - Member Comparison{% endblock %}

{% block header_title %}{{ team_display_name }} - Member Comparison{% endblock %}

{% block page_description %}
<div style="font-size: 1.2em; color: var(--text-secondary); margin-bottom: 15px;">
    Team Member Performance Comparison
</div>
{% endblock %}

{% block period_info %}
ðŸ“Š Comparing last {{ config.days_back if config else 90 }} days
{% endblock %}

{% block breadcrumb_items %}
<a href="/team/{{ team_name }}">{{ team_display_name }}</a>
<a href="/team/{{ team_name }}/compare">Member Comparison</a>
{% endblock %}

{% block main_content %}
<div class="card">
            <h2>Team Member Metrics Comparison</h2>
            <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 8px 0 15px 0; line-height: 1.4;">
                Performance comparison across team members. Best values in each metric are highlighted. Use this to identify strong performers and opportunities for mentoring.
            </p>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Member</th>
                        <th>PRs Created</th>
                        <th>Merge Rate</th>
                        <th>Reviews Given</th>
                        <th>Commits</th>
                        <th>Lines Added</th>
                        <th>Lines Deleted</th>
                        <th>Avg Cycle Time</th>
                        <th>Jira Completed</th>
                        <th>Jira WIP</th>
                        <th>Jira Cycle Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in comparison_data %}
                    <tr>
                        <td class="username-cell">
                            <a href="/person/{{ member.username }}">{{ member.username }}</a>
                        </td>
                        <td>
                            {% if member.prs == comparison_data|map(attribute='prs')|max %}
                            <span class="best-value">{{ member.prs }}</span>
                            {% else %}
                            {{ member.prs }}
                            {% endif %}
                        </td>
                        <td>
                            {% if member.merge_rate == comparison_data|map(attribute='merge_rate')|max %}
                            <span class="best-value">{{ "%.0f"|format(member.merge_rate) }}%</span>
                            {% else %}
                            {{ "%.0f"|format(member.merge_rate) }}%
                            {% endif %}
                        </td>
                        <td>
                            {% if member.reviews == comparison_data|map(attribute='reviews')|max %}
                            <span class="best-value">{{ member.reviews }}</span>
                            {% else %}
                            {{ member.reviews }}
                            {% endif %}
                        </td>
                        <td>
                            {% if member.commits == comparison_data|map(attribute='commits')|max %}
                            <span class="best-value">{{ member.commits }}</span>
                            {% else %}
                            {{ member.commits }}
                            {% endif %}
                        </td>
                        <td>
                            {% if member.lines_added == comparison_data|map(attribute='lines_added')|max %}
                            <span class="best-value">+{{ member.lines_added }}</span>
                            {% else %}
                            +{{ member.lines_added }}
                            {% endif %}
                        </td>
                        <td>
                            {% if member.lines_deleted == comparison_data|map(attribute='lines_deleted')|max %}
                            <span class="best-value">-{{ member.lines_deleted }}</span>
                            {% else %}
                            -{{ member.lines_deleted }}
                            {% endif %}
                        </td>
                        <td>{{ "%.1f"|format(member.cycle_time) }}h</td>
                        <td>
                            {% if member.jira_completed == comparison_data|map(attribute='jira_completed')|max and member.jira_completed > 0 %}
                            <span class="best-value">{{ member.jira_completed }}</span>
                            {% else %}
                            {{ member.jira_completed }}
                            {% endif %}
                        </td>
                        <td>{{ member.jira_wip }}</td>
                        <td>{{ "%.1f"|format(member.jira_cycle_time) }}h</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 style="margin: 40px 0 20px 0; font-size: 24px;">Visual Comparison</h2>
        <p style="font-size: 13px; color: var(--text-secondary, #7f8c8d); margin: 0 0 20px 0; line-height: 1.4;">
            Visual comparison of individual contributions across team members. Charts show relative activity levels and code volume.
        </p>
        <div class="charts-grid">
            <div class="card">
                <h2>Pull Requests Created</h2>
                <div id="prs-chart"></div>
            </div>

            <div class="card">
                <h2>Code Reviews Given</h2>
                <div id="reviews-chart"></div>
            </div>

            <div class="card">
                <h2>Commits</h2>
                <div id="commits-chart"></div>
            </div>

            <div class="card">
                <h2>Lines Changed</h2>
                <div id="lines-chart"></div>
            </div>

            <div class="card">
                <h2>Jira Issues Completed</h2>
                <div id="jira-completed-chart"></div>
            </div>

            <div class="card">
                <h2>Jira Work In Progress</h2>
                <div id="jira-wip-chart"></div>
            </div>
        </div>
    </div>

    <script>
        // Get theme-aware colors
        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                font_color: isDark ? '#e0e0e0' : '#2c3e50',
                grid_color: isDark ? '#444' : '#ecf0f1'
            };
        }

        // PRs Created Chart
        var prsData = [{
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.prs }},{% endfor %}],
            type: 'bar',
            marker: {
                color: '#3498db',
                line: {
                    color: '#2980b9',
                    width: 1.5
                }
            }
        }];

        var colors = getChartColors();
        var prsLayout = {
            yaxis: {title: 'Number of PRs', gridcolor: colors.grid_color, color: colors.font_color},
            xaxis: {color: colors.font_color},
            paper_bgcolor: colors.paper_bgcolor,
            plot_bgcolor: colors.plot_bgcolor,
            font: {color: colors.font_color},
            margin: {l: 60, r: 40, t: 20, b: 80}
        };
        Plotly.newPlot('prs-chart', prsData, prsLayout, {responsive: true});

        // Reviews Chart
        var reviewsData = [{
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.reviews }},{% endfor %}],
            type: 'bar',
            marker: {
                color: '#9b59b6',
                line: {
                    color: '#8e44ad',
                    width: 1.5
                }
            }
        }];

        var reviewsLayout = {
            yaxis: {title: 'Number of Reviews', gridcolor: colors.grid_color, color: colors.font_color},
            xaxis: {color: colors.font_color},
            paper_bgcolor: colors.paper_bgcolor,
            plot_bgcolor: colors.plot_bgcolor,
            font: {color: colors.font_color},
            margin: {l: 60, r: 40, t: 20, b: 80}
        };
        Plotly.newPlot('reviews-chart', reviewsData, reviewsLayout, {responsive: true});

        // Commits Chart
        var commitsData = [{
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.commits }},{% endfor %}],
            type: 'bar',
            marker: {
                color: '#27ae60',
                line: {
                    color: '#229954',
                    width: 1.5
                }
            }
        }];

        var commitsLayout = {
            yaxis: {title: 'Number of Commits', gridcolor: colors.grid_color, color: colors.font_color},
            xaxis: {color: colors.font_color},
            paper_bgcolor: colors.paper_bgcolor,
            plot_bgcolor: colors.plot_bgcolor,
            font: {color: colors.font_color},
            margin: {l: 60, r: 40, t: 20, b: 80}
        };
        Plotly.newPlot('commits-chart', commitsData, commitsLayout, {responsive: true});

        // Lines Changed Chart (Stacked)
        var linesAddedData = {
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.lines_added }},{% endfor %}],
            name: 'Lines Added',
            type: 'bar',
            marker: {color: '#27ae60'}
        };

        var linesDeletedData = {
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.lines_deleted }},{% endfor %}],
            name: 'Lines Deleted',
            type: 'bar',
            marker: {color: '#e74c3c'}
        };

        var linesLayout = {
            yaxis: {title: 'Lines of Code', gridcolor: colors.grid_color, color: colors.font_color},
            xaxis: {color: colors.font_color},
            barmode: 'group',
            paper_bgcolor: colors.paper_bgcolor,
            plot_bgcolor: colors.plot_bgcolor,
            font: {color: colors.font_color},
            legend: {
                x: 0.5,
                xanchor: 'center',
                y: 1.1,
                yanchor: 'bottom',
                orientation: 'h'
            },
            margin: {l: 60, r: 40, t: 60, b: 80}
        };
        Plotly.newPlot('lines-chart', [linesAddedData, linesDeletedData], linesLayout, {responsive: true});

        // Jira Completed Chart
        var jiraCompletedData = [{
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.jira_completed }},{% endfor %}],
            type: 'bar',
            marker: {
                color: '#f39c12',
                line: {
                    color: '#e67e22',
                    width: 1.5
                }
            }
        }];

        var jiraCompletedLayout = {
            yaxis: {title: 'Issues Completed', gridcolor: colors.grid_color, color: colors.font_color},
            xaxis: {color: colors.font_color},
            paper_bgcolor: colors.paper_bgcolor,
            plot_bgcolor: colors.plot_bgcolor,
            font: {color: colors.font_color},
            margin: {l: 60, r: 40, t: 20, b: 80}
        };
        Plotly.newPlot('jira-completed-chart', jiraCompletedData, jiraCompletedLayout, {responsive: true});

        // Jira WIP Chart
        var jiraWipData = [{
            x: [{% for m in comparison_data %}'{{ m.username }}',{% endfor %}],
            y: [{% for m in comparison_data %}{{ m.jira_wip }},{% endfor %}],
            type: 'bar',
            marker: {
                color: '#e74c3c',
                line: {
                    color: '#c0392b',
                    width: 1.5
                }
            }
        }];

        var jiraWipLayout = {
            yaxis: {title: 'Work In Progress', gridcolor: colors.grid_color, color: colors.font_color},
            xaxis: {color: colors.font_color},
            paper_bgcolor: colors.paper_bgcolor,
            plot_bgcolor: colors.plot_bgcolor,
            font: {color: colors.font_color},
            margin: {l: 60, r: 40, t: 20, b: 80}
        };
        Plotly.newPlot('jira-wip-chart', jiraWipData, jiraWipLayout, {responsive: true});
    </script>
{% endblock %}
